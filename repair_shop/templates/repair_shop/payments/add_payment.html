{% extends 'repair_shop/base.html' %}
{% load static %}

{% block title %}Record Payment — {{ transaction.code }} - Bayo Electronics{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="bi bi-cash-coin"></i> Record Payment</h1>
    <a href="{% url 'repair_shop:repair_transaction_detail' transaction.id %}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to Repair
    </a>
</div>

<div class="row">

    <!-- Payment Form -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header fw-bold">
                <i class="bi bi-receipt"></i> New Payment — <code>{{ transaction.code }}</code>
            </div>
            <div class="card-body">

                <!-- Outstanding Balance Banner -->
                <div class="alert alert-warning d-flex align-items-center gap-3 mb-4">
                    <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                    <div>
                        <div class="fw-bold">Outstanding Balance: D{{ total_due|floatformat:2 }}</div>
                        <small>Total Cost: D{{ total_cost|floatformat:2 }} &bull; Paid So Far: D{{ total_paid|floatformat:2 }}</small>
                    </div>
                </div>

                <form method="post" novalidate id="paymentForm">
                    {% csrf_token %}

                    <!-- Payment Type -->
                    <div class="mb-3">
                        <label for="{{ form.payment_type.id_for_label }}" class="form-label">
                            <i class="bi bi-credit-card"></i> {{ form.payment_type.label }}
                        </label>
                        {{ form.payment_type }}
                        {% if form.payment_type.errors %}
                        <div class="invalid-feedback d-block">{{ form.payment_type.errors|join:", " }}</div>
                        {% endif %}
                    </div>

                    <!-- Amount -->
                    <div class="mb-3">
                        <label for="{{ form.amount.id_for_label }}" class="form-label">
                            <i class="bi bi-currency-dollar"></i> {{ form.amount.label }}
                        </label>
                        {{ form.amount }}
                        <small class="text-muted">Outstanding: D{{ total_due|floatformat:2 }}</small>
                        {% if form.amount.errors %}
                        <div class="invalid-feedback d-block">{{ form.amount.errors|join:", " }}</div>
                        {% endif %}
                    </div>

                    <!-- Mobile Money fields (shown/hidden via JS) -->
                    <div id="mobilemoneyFields" style="display:none;">
                        <div class="mb-3">
                            <label for="{{ form.mobile_provider.id_for_label }}" class="form-label">
                                <i class="bi bi-phone"></i> {{ form.mobile_provider.label }}
                            </label>
                            {{ form.mobile_provider }}
                            {% if form.mobile_provider.errors %}
                            <div class="invalid-feedback d-block">{{ form.mobile_provider.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.mobile_number.id_for_label }}" class="form-label">
                                <i class="bi bi-hash"></i> {{ form.mobile_number.label }}
                            </label>
                            {{ form.mobile_number }}
                            {% if form.mobile_number.errors %}
                            <div class="invalid-feedback d-block">{{ form.mobile_number.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="mb-4">
                        <label for="{{ form.notes.id_for_label }}" class="form-label">
                            <i class="bi bi-chat-left-text"></i> {{ form.notes.label }}
                        </label>
                        {{ form.notes }}
                    </div>

                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">{{ form.non_field_errors }}</div>
                    {% endif %}

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success btn-lg flex-grow-1">
                            <i class="bi bi-check-circle"></i> Save Payment
                        </button>
                        <a href="{% url 'repair_shop:repair_transaction_detail' transaction.id %}" class="btn btn-outline-secondary btn-lg">
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Previous Payments & Summary -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header fw-bold">
                <i class="bi bi-clock-history"></i> Payment History
            </div>
            <div class="card-body p-0">
                {% if payments %}
                <div class="list-group list-group-flush">
                    {% for p in payments %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                {% if p.payment_type == 'CASH' %}
                                <span class="badge bg-secondary me-2"><i class="bi bi-cash"></i> Cash</span>
                                {% else %}
                                <span class="badge bg-info text-dark me-2"><i class="bi bi-phone"></i> Mobile Money</span>
                                {% endif %}
                                {% if p.mobile_provider %}<small class="text-muted">{{ p.mobile_provider }}</small>{% endif %}
                                {% if p.mobile_number %}<small class="text-muted"> / {{ p.mobile_number }}</small>{% endif %}
                                <br>
                                <small class="text-muted">{{ p.created_at|date:"M d, Y H:i" }} by {{ p.recorded_by.username|default:"?" }}</small>
                            </div>
                            <strong class="text-success">D{{ p.amount|floatformat:2 }}</strong>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="p-3 text-muted small"><i class="bi bi-info-circle"></i> No previous payments.</div>
                {% endif %}
            </div>
        </div>

        <!-- Summary Card -->
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <h6 class="fw-bold mb-3"><i class="bi bi-calculator"></i> Balance Summary</h6>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Total Repair Cost</span>
                    <strong>D{{ total_cost|floatformat:2 }}</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Total Paid</span>
                    <strong class="text-success">D{{ total_paid|floatformat:2 }}</strong>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <span class="fw-bold">Outstanding</span>
                    <strong class="text-danger fs-5">D{{ total_due|floatformat:2 }}</strong>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
// Show/hide mobile money fields based on payment type selection
const paymentTypeSelect = document.getElementById('id_payment_type');
const mobileFields = document.getElementById('mobilemoneyFields');

function toggleMobileFields() {
    if (paymentTypeSelect && paymentTypeSelect.value === 'MOBILE_MONEY') {
        mobileFields.style.display = 'block';
    } else {
        mobileFields.style.display = 'none';
    }
}

if (paymentTypeSelect) {
    paymentTypeSelect.addEventListener('change', toggleMobileFields);
    toggleMobileFields(); // Run on load in case of form re-render with errors
}
</script>
{% endblock %}
